const help={JsonFromLink(t){if(t&&t.url)try{return JSON.parse(`{${t.url}}`)}catch(t){return!1}return!1},getCharInfo(...t){let e,o,n,i,r=null;if("function"==typeof t[t.length-1]&&(r=t.pop()),1===t.length&&Array.isArray(t[0])&&2===t[0].length){let[r,l]=t[0];r=Math.floor(r),l=Math.floor(l);const a=help.pixelToCell([r,l]);[e,o,n,i]=a}else if(1===t.length&&Array.isArray(t[0])&&4===t[0].length)[e,o,n,i]=t[0];else if(1===t.length&&"object"==typeof t[0]){const r=t[0];if("tileX"in r&&(e=r.tileX),"tileY"in r&&(o=r.tileY),"charX"in r&&(n=r.charX),"charY"in r&&(i=r.charY),"x"in r&&"y"in r){const t=help.pixelToCell([Math.round(r.x),Math.round(r.y)]);[e,o,n,i]=t}}else{if(!cursorCoords)return null;[e,o,n,i]=cursorCoords}const l=getChar(e,o,n,i),a=getCharColor(e,o,n,i),s=getCharProtection(e,o,n,i),c=getLink(e,o,n,i),h=help.JsonFromLink(c);let u=null;return r&&(u=r(l)),{loaded:isTileLoaded(e,o),char:l,color:a,bgColor:getCharBgColor(e,o,n,i),protection:s,decoration:getCharDecoration(e,o,n,i),link:c,json:h,empty:(0==l.trim().length||[6158,8192,8193,8194,8195,8196,8197,8198,8199,8200,8201,8202,8203,8204,8205,8239,8287,8288,12288,10240,12644,65279,,32].includes(l.charCodeAt())||a===resolveColorValue(styles[["public","member","owner"][s]]))&&!c,custom:u}},coordinateAdd(...t){let e,o,n,i,r,l,a,s;if(t[0]instanceof Array&&5===t.length)[e,o,n,i]=t[0],[r,l,a,s]=t.slice(1);else if(t[4]instanceof Array&&5===t.length)[e,o,n,i]=t,[r,l,a,s]=t[4];else if(8===t.length)[e,o,n,i,r,l,a,s]=t;else if(2===t.length&&t[0]instanceof Array&&t[1]instanceof Array)[e,o,n,i]=t[0],[r,l,a,s]=t[1];else{if(!(1===t.length&&t[0]instanceof Array))return null;8==t[0].length&&([e,o,n,i,r,l,a,s]=t[0])}return[e+r+Math.floor((n+a)/tileC),o+l+Math.floor((i+s)/tileR),n+a-Math.floor((n+a)/tileC)*tileC,i+s-Math.floor((i+s)/tileR)*tileR]},pixelToCell(...t){let e,o;if(2===t.length)[e,o]=t;else if(1===t.length&&Array.isArray(t[0])&&2===t[0].length)[e,o]=t[0];else{if(1!==t.length||"object"!=typeof t[0])throw new Error("Invalid input format. Use either (x, y), [x, y], or an object with x and y properties.");"x"in t[0]&&(e=t[0].x),"y"in t[0]&&(o=t[0].y)}e=Math.round(e),o=Math.round(o);var n=0,i=0,r=e-positionX-Math.trunc(owotWidth/2),l=o-positionY-Math.trunc(owotHeight/2);return n=Math.floor(r/cellW),i=Math.floor(l/cellH),[Math.floor(n/tileC),Math.floor(i/tileR),n-=Math.floor(n/tileC)*tileC,i-=Math.floor(i/tileR)*tileR]},cellToPixel(...t){let e,o,n,i;if(Array.isArray(t[0])?[e=0,o=0,n=0,i=0]=t[0]:"object"==typeof t[0]?("tileX"in t[0]&&(e=t[0].tileX),"tileY"in t[0]&&(o=t[0].tileY),"charX"in t[0]&&(n=t[0].charX),"charY"in t[0]&&(i=t[0].charY)):[e=0,o=0,n=0,i=0]=t,t.length>4||void 0===e||void 0===o||void 0===n||void 0===i)return void console.error(`CellToPixelCoords: Invalid cellCoords. Arguments can either be ([x, y, z, w]) or (x,y,z,w) or an object with tileX, tileY, charX, charY. Your cellCoords was: ${t}`);return[Math.round(e)*tileW+n*cellW+Math.round(positionX)+Math.round(owotWidth/2),Math.round(o)*tileH+i*cellH+Math.round(positionY)+Math.round(owotHeight/2)]},lerp(t=0,e=0,o=.5,n=!1){if("object"==typeof t&&"object"==typeof e){if(Array.isArray(t))return t.map(((t,i)=>help.lerp(t,e[i],o,n)));const i={};for(const r in t)e.hasOwnProperty(r)&&(i[r]=help.lerp(t[r],e[r],o,n));return i}if(Array.isArray(t)){if("number"==typeof e)return t.map((t=>help.lerp(t,e,o,n)));if(Array.isArray(e)){if(1===e.length)return t.map((t=>help.lerp(t,e[0],o,n)));if(t.length===e.length)return t.map(((t,i)=>help.lerp(t,e[i],o,n)))}}let i=(1-o)*t+o*e;if(!1!==n)if("number"==typeof n){const t=1/n;i=Math.round(i*t)/t}else i=Math.round(i);return i},subtract(t=[0],e=0,o=!1){if(Array.isArray(t)){if(Array.isArray(e)){if(t.length===e.length){return t.map(((t,n)=>{let i=t-e[n];return o&&(i=Math.round(i)),i}))}}else if("number"==typeof e){return t.map((t=>{let n=t-e;return o&&(n=Math.round(n)),n}))}}else if("object"==typeof t&&"object"==typeof e){const n={};for(const i in t)e.hasOwnProperty(i)&&(n[i]=t[i]-e[i],o&&(n[i]=Math.round(n[i])));return n}},add(t=[0],e=0,o=!1){if(Array.isArray(t)){if(Array.isArray(e)){if(t.length===e.length){return t.map(((t,n)=>{let i=t+e[n];return o&&(i=Math.round(i)),i}))}}else if("number"==typeof e){return t.map((t=>{let n=t+e;return o&&(n=Math.round(n)),n}))}}else if("object"==typeof t&&"object"==typeof e){const n={};for(const i in t)e.hasOwnProperty(i)&&(n[i]=t[i]+e[i],o&&(n[i]=Math.round(n[i])));return n}},correctLocation(...t){let e=null;if(Array.isArray(t[0]))e=t[0];else if(t[0]instanceof Object){const{tileX:o=0,tileY:n=0,charX:i=0,charY:r=0}=t[0];e=[o,n,i,r]}else e=t;const o=e.map((t=>Math.round(t))),n=[...o];return o[2]>15&&(n[2]=(o[2]%16+(o[2]<0?17:0)+16)%16,n[0]+=Math.abs(Math.ceil(-o[2]/16))),o[2]<0&&(n[2]=(o[2]%16+(o[2]<0?17:0)-1+16)%16,n[0]-=Math.ceil(-o[2]/16)),o[3]>7&&(n[3]=(o[3]%8+(o[3]<0?9:0)+8)%8,n[1]+=Math.abs(Math.ceil(-o[3]/8))),o[3]<0&&(n[3]=(o[3]%8+(o[3]<0?9:0)-1+8)%8,n[1]-=Math.ceil(-o[3]/8)),n},getDistance(t,e,o=!1,n=!1){let i,r,l,a;if(Array.isArray(t)&&Array.isArray(e))[i,r]=t,[l,a]=e;else{if(!("object"==typeof t&&"object"==typeof e&&"x"in t&&"y"in t&&"x"in e&&"y"in e))throw new Error("Invalid arguments");i=t.x,r=t.y,l=e.x,a=e.y}n&&(i/=cellW,r/=cellH,l/=cellW,a/=cellH);const s=l-i,c=a-r,h=Math.sqrt(s*s+c*c);return o?[s,c]:h},AreArraysEqual(t,e){if(!t||!e)return!1;if(t.length!==e.length)return!1;for(let o=0;o<t.length;o++)if(t[o]!==e[o])return!1;return!0},localwriteCharTo(t,e,o,n,i,r,l=-1,a=!1,s=!1,c=!1,h=!1){Tile.get(o,n)||Tile.set(o,n,blankTile());var u=Tile.get(o,n),p=u.properties.cell_props;p||(p={});var d=u.properties.color,f=u.properties.bgcolor;d||(d=new Array(tileArea).fill(0));var y,g,m,b,v,x;getLink(o,n,i,r);p[r]&&p[r][i]&&delete p[r][i],d[r*tileC+i],d[r*tileC+i]=e,u.properties.color=d,f||-1==l||(f=new Array(tileArea).fill(-1),u.properties.bgcolor=f),f&&(f[r*tileC+i],f[r*tileC+i]=l),u.properties.cell_props=p,x=getCharTextDecorations(t),t=clearCharTextDecorations(t),t=detectCharEmojiCombinations(t)||t,g=textDecorationModes.bold,m=textDecorationModes.italic,b=textDecorationModes.under,v=textDecorationModes.strike,x&&(g=g||x.bold,m=m||x.italic,b=b||x.under,v=v||x.strike),t=setCharTextDecorations(t,g,m,b,v);var A=u.content;y=A[r*tileC+i],A[r*tileC+i]=t,y!=t&&(hasChanged=!0),w.setTileRedraw(o,n,!0),bufferLargeChars&&(0==r&&w.setTileRedraw(o,n-1,!0),i==tileC-1&&w.setTileRedraw(o+1,n,!0),0==r&&i==tileC-1&&w.setTileRedraw(o+1,n-1,!0))},getLinePositions(t,e,o){const n="Start and End arguments can either be pixel-based [x,y] or they can be cell-based [tileX, tileY, charX, charY] arrays, or objects{x,y} or objects{tileX, tileY, charX, charY} type help.getLinePositions.info() for more information";function i(t){return"object"==typeof t&&"x"in t&&"y"in t?[t.x,t.y]:null}function r(t){return"object"==typeof t&&"tileX"in t&&"tileY"in t&&"charX"in t&&"charY"in t?[t.tileX,t.tileY,t.charX,t.charY]:null}const l=i(t)||r(t)||t,a=i(e)||r(e)||e;if(!Array.isArray(l)||!Array.isArray(a))throw new Error(n);let s,c;if(2===l.length)s=l.slice();else{if(4!==l.length)throw new Error(n);s=help.cellToPixel(l)}if(2===a.length)c=a.slice();else{if(4!==a.length)throw new Error(n);c=help.cellToPixel(a)}let h=help.getDistance(s,c,!1,!0);const u=[];if(0!==h){const t=1/h;let e=null;for(let n=0;n<1;n+=t){const t=help.pixelToCell(help.lerp(s,c,n,!0));if(!help.AreArraysEqual(e,t)){const[n,i,r,l]=t;e=t,o(n,i,r,l),u.push(t)}}}return u},getSquarePositions(...t){let e,o=0,n=1,i=!1,r=!1,l=null;function a(t,e,o){t&&highlight([e],!0,int_to_rgb(o))}function s(t,e,o,n,i){const r=e,l=t,a=l<i,s=l>=o-i;let c,h,u;r<i?a?(c=255,u="topLeft"):s?(c=754674,u="bottomLeft"):(c=7542674,u="trueLeft"):r>=o-i?a?(c=23463,u="topRight"):s?(c=2343463,u="bottomRight"):(c=23434463,u="trueRight"):a?(c=53434463,u="topCenter"):s?(c=939434463,u="bottomCenter"):(c=93943,u="innerSquare"),h=help.coordinateAdd(n,[0,0,r,l]);const[p,d,f,y]=h;return{color:c,position:h,type:u}}function c(t,e,o){255===e?t.top.left.push(o):754674===e?t.bottom.left.push(o):7542674===e?t.left.push(o):23463===e?t.top.right.push(o):2343463===e?t.bottom.right.push(o):23434463===e?t.right.push(o):53434463===e?t.top.center.push(o):939434463===e?t.bottom.center.push(o):t.center.push(o)}t.length>=1&&(e=t[0]),t.length>=2&&("number"==typeof t[1]?o=t[1]:"function"==typeof t[1]?l=t[1]:"boolean"==typeof t[1]?(i=t[1],r=t[1]):n=t[1]),t.length>=3&&("number"==typeof t[2]?"number"==typeof t[1]?n=t[2]:o=t[2]:"boolean"==typeof t[2]?r=t[2]:l=t[2]),t.length>=4&&(r=t[3]),t.length>=5&&(l=t[4]),2==e.length&&(e=help.pixelToCell(e));const h=2*(o+n)+1,u=function(t,e,o){return help.coordinateAdd(t,[0,0,-1*(e+o),-1*(e+o)])}(e,o,n),p={top:{left:[],center:[],right:[]},bottom:{left:[],center:[],right:[]},left:[],right:[],center:[]};for(let t=0;t<h;t++)for(let e=0;e<h;e++){const{color:o,position:i,type:d}=s(t,e,h,u,n);"function"==typeof l&&l(d,i),a(r,i,o),c(p,o,i)}return p},getMouseData(){const[t,e]=currentMousePosition,o=help.pixelToCell(t,e);return{pos:{screen:[t,e],cell:o},charInfo:help.getCharInfo(o)}},username:w.clientId,throttle(t,e){let o=0;return function(...n){const i=Date.now();i-o>=e&&(t.apply(this,n),o=i)}},updateName:()=>OWOT.events.chat?(fn=function(...t){const e=t.find((t=>"object"==typeof t&&t.type));e?e&&/^T\w+( \w+)*\.$/.test(e.message)&&!e.date&&("anon_nick"===e.type?name=(fn,`${e.nickname}_${e.id}`):name=(fn,e.nickname||e.realUsername||e.id||w.clientId)):(OWOT.events.chat.push(fn),api_chat_send("/test"))},fn(fn)):w.clientId,AutoUpdateName(){w.on("frame",help.throttle(help.updateName,1e3))},UIButton:class{constructor(t,e,o){this.text=t,this.position=e,this.callback=o,this.buttonElement=document.createElement("button"),this.buttonElement.textContent=this.text,this.buttonElement.style.position="absolute",this.buttonElement.style.left=`${this.position.x}px`,this.buttonElement.style.top=`${this.position.y}px`,this.buttonElement.style.padding="10px 20px",this.buttonElement.style.backgroundColor="#007bff",this.buttonElement.style.color="#fff",this.buttonElement.style.border="none",this.buttonElement.style.borderRadius="5px",this.buttonElement.style.cursor="pointer",this.buttonElement.addEventListener("mouseover",(()=>{this.buttonElement.style.backgroundColor="#0056b3"})),this.buttonElement.addEventListener("mouseout",(()=>{this.buttonElement.style.backgroundColor="#007bff"})),this.buttonElement.addEventListener("click",(()=>{"function"==typeof this.callback&&this.callback()})),document.body.appendChild(this.buttonElement)}setText(t){this.text=t,this.buttonElement.textContent=this.text}setPosition(t){this.position=t,this.buttonElement.style.left=`${this.position.x}px`,this.buttonElement.style.top=`${this.position.y}px`}setCallback(t){this.callback=t}},automation:{Step:class{constructor(t,e,o){this.callback=t,this.sequencer=e,this.conditional="function"==typeof o?o:()=>!0}async execute(){for(;this.sequencer.step!==this.stepNumber||!this.conditional();)await new Promise((t=>setTimeout(t,0)));await new Promise((t=>setTimeout(t,0))),this.callback()}setStepNumber(t){this.stepNumber=t}},Sequencer:class{constructor(t){this.step=0,this.currentStepNumber=0,this.steps=[],this.name=t,this.data={}}createStep(t,e){const o=new help.automation.Step(t,this,e);return o.setStepNumber(this.currentStepNumber),this.currentStepNumber++,this.steps.push(o),o}async sequenceLoop(){for(;;)for(const t of this.steps)await t.execute()}stepUp(){this.step++,this.step>=this.steps.length&&(this.step=0)}stepDown(){this.step>0?this.step--:this.step=this.steps.length-1}}},KeybindingManager:class{constructor(t){this.eventKeybindings=new Map,this.handleKeyPress=this.handleKeyPress.bind(this),t.addEventListener("keydown",this.handleKeyPress),t.addEventListener("keyup",this.handleKeyPress)}addKeybinding(t,e,o){this.eventKeybindings.has(t)||this.eventKeybindings.set(t,[]),this.eventKeybindings.get(t).push({key:e,callback:o})}removeKeybinding(t,e){const o=this.eventKeybindings.get(t);if(o){const n=o.findIndex((t=>t.key===e));-1!==n&&(o.splice(n,1),0===o.length&&this.eventKeybindings.delete(t))}}handleKeyPress(t){const e=t.key;for(const[o,n]of this.eventKeybindings){const o=n.find((t=>t.key===e));o&&(o.callback(t),t.preventDefault())}}listKeybindings(){return Array.from(this.eventKeybindings.entries()).map((([t,e])=>({event:t,key:e.map((t=>t.key))})))}},build(){help.updateName(),help.getCharInfo.info=function(){console.warn("help.getCharInfo:\nThis function is used to get infomation about a cell's: char, colors, decorations, protection, and if it appears empty.\n\nThe following examples are considered valid inputs: \n(a,b,c,d)\n(array[4])\nan object containing tileX, tileY, charX, charY keys.\n\nExample usage: help.getCharInfo(cursorCoords) this will get cell data of your current cursor.\nThis would be useful when trying to determine if a cell is protected, and what kind of data is in the cell in case we wanna do collision detection of a game or store a cells value for use later.\n")},help.coordinateAdd.info=function(){console.warn("help.coordinateAdd:\nThis function is used to add two cell coordinates together.\n\nThe following examples are considered valid inputs: \n(a,b,c,d,e,f,g,h)\n(array[4], e,f,g,h)\n(a,b,c,d,array[4])\n(array[4], array[4])\n(array[8])\n\nExample usage: help.coordinateAdd(cursorCoords,[0,0,0,1]) this will get the coords 1 to the right of your cursor coordinate.\nThis would be useful to get a cell that is nearby another.\n")},help.pixelToCell.info=function(){console.warn("help.pixelToCell:\nThis function is used to a convert pixel coordinate [x,y] to a cell coordinate [tileX, tileY, charX, charY].\n\nThe following examples are considered valid inputs: \n(x,y)\n(array[2])\nan object containing x, y keys such as a click event object.\n\nExample usage: function (e) { help.pixelToCell(e) this will get the coords from the event x,y pixel location.\nThis would be useful when trying to get a pixel coord from a mouse or perhaps from a pixel-based character on another canvas, and translating it to the nearest cell on the owot canvas.\n")},help.cellToPixel.info=function(){console.warn("help.cellToPixel:\nThis function is used to a convert cell coordinate [tileX, tileY, charX, charY] to a pixel coordinate [x,y].\n\nThe following examples are considered valid inputs: \n(x,y,z,w)\n(array[4])\nan object containing tileX, tileY, charX, charY keys.\n\nExample usage: help.cellToPixel([5,5,4,4]) this will return a pixel [x,y] location.\nThis would be useful when trying translate cell coords to pixel coords.\n")},help.lerp.info=function(){console.warn("help.lerp:\nThis function is used to blend numbers together. (start, end, amt = 0.5, roundResult = false)\n\nThe following examples are considered valid inputs: (amt and roundResult are optional): \n(a,b)\n(array[N] , b)\n(array[N],array[N])\n(object,object)\n\nExample usage: help.lerp([0, 100], [100, 200], 0.5)); this Outputs: [50, 150].\nThis would be useful when trying get coords along a linear path, or having a smooth change in a character's speed; slowly increasing or decreasing. \nFeature: roundResult can be set to false to not round, true to round to the nearest integer, or you can set a specific number to round to for example help.lerp(10,2,0.1,0.25) = 9.25 instead of 9 or 9.2.\n")},help.subtract.info=function(){console.warn("help.subtract:\nThis function is used to substract two variables from eachother. It can be arrays, numbers and objects.\n\nThe following examples are considered valid inputs: \n(array , array)\n(array , number)\n(object, object)\n\nExample usage:  help.subtract([10,10,5,5],1), the output would be [9,9,4,4] \n")},help.add.info=function(){console.warn("help.add:\nThis function is used to add two variables together. It can be arrays, numbers and objects.\n\nThe following examples are considered valid inputs: \n(array , array)\n(array , number)\n(object, object)\n\nExample usage: help.add([10,10,5,5],1), the output would be [11,11,6,6] \n")},help.correctLocation.info=function(){console.warn("help.correctLocation:\nThis function is used to convert an invalid cell location into a valid one.\n\nThe following examples are considered valid inputs: (amt and roundResult are optional): \n(a,b,c,d)\n([a,b,c,d])\nan object containing tileX, tileY, charX, charY keys.\n\nExample usage: help.correctLocation(10,10,5,100) x is 100 which is invalid so the tileX value is shifted. This outputs: [10, 22, 5, 4]\nThis would be useful when moving a character left or right, or over large distances, just update the cellX or cellY and this will correct any issues for you.\n")},help.getDistance.info=function(){console.warn("help.getDistance:\nThis function is used to return the distance between two [x,y] or {x,y} points either in pixel space or in owot cell space.\nThe following examples are considered valid inputs: (separate, cellUnit, are both optional): ([x,y]) || ({x,y})\nExample usage: help.getDistance([10,0],[0,0],true,true) this will return [-1, 0] since seperate == true and we are converting to cell coords\nThis would be useful for checking the distance between two 2d coords.\n")},help.AreArraysEqual.info=function(){console.warn("help.AreArraysEqual:\nThis function returns true if two arrays are the same.\nThe following examples are considered valid inputs: (array,array)\nExample usage: help.AreArraysEqual([10,0],[0,0]) this will return false\nThis would be useful for checking two arrays against eachother, like when looping through pixels and converting to cell coords, if you only want to return cellcoords when they are not the same as the one before it.\n")},help.getLinePositions.info=function(){console.warn("help.getLinePositions:\nThis  function has a looped callback of (tileX, tileY, charX, charY). it will also return an array at the end of the function call.\n\nThe following examples are considered valid inputs: \narray[tileX, tileY, charX, charY]\narray[x,y]\nobject{x,y}\nobject{tileX, tileY, charX, charY}\n\nExample usage: help.getLinePositions(startCoords, endCoords,function(a, b, c, d){console.log(a, b, c, d)}) this will run a callback and log all the coords.\nThis would be useful for getting points in a line between two points. The callback data can be used for building line drawers.\n")},help.getSquarePositions.info=function(){console.warn("help.getSquarePositions:\nThis  function has a looped callback of type, position(tileX, tileY, charX, charY). it will also return an object at the end of the function call.\n\nThe following examples are considered valid inputs: \ngetSquarePositions(centerPosition);\ngetSquarePositions(centerPosition);\ngetSquarePositions(centerPosition, cellBuffer);\ngetSquarePositions(centerPosition, callback);\ngetSquarePositions(centerPosition, distanceFromCenter);\ngetSquarePositions(centerPosition, cellBuffer, debug);\ngetSquarePositions(centerPosition, distanceFromCenter, callback);\ngetSquarePositions(centerPosition, cellBuffer, debug, callback);\n\nExample usage: help.getSquarePositions(cursorCoords,true,function(color,position){console.log(color,position)}). This function will console log each positin and color, it will also highlight the square.\nThis will be usefull for drawing squares, or using this with a character for collision detection or serrounding cells.\n")},help.getMouseData.info=function(){console.warn("help.getMouseData:\nThis  function returns the mouse location in pixel-space and cell-space. It also gets the character data under the mouse position.\n")},help.throttle.info=function(){console.warn("help.throttle:\nThis  function is used to rate-limit a function. \nExample usage: help.throttle(myFunction,1000); myFunction(){console.log(hello);}\n\n")},help.build=null}};help.build();const platformer={data:{players:[],layers:[]},settings:{gravity:[0,8],slowdown:.05,debug:!1,collideWithCanvas:!0,pixelcollision:!1,autoCenterPlayer:!0},controls:new help.KeybindingManager(elm.textInput),CharAttributes:class{constructor(){this.attributes={breakable:"",harmfulFromSides:"",harmfulFromTop:"",harmfulFromBottom:"",jumpthrough:"^🠅",fallthough:"v🠇",leftthough:"<◢◤🠄",rightthough:">◥◣🠆",though_updown:"|",though_leftright:"-",autoLeft:"◢◤🠄",autoRight:"◥◣🠆",autoUp:"^🠅",autoDown:"v🠇",climb:"𜲄",ignore:"𜲄"}}addChar(t,e){this.attributes.hasOwnProperty(t)&&(this.attributes[t]+=e)}removeChar(t,e){this.attributes.hasOwnProperty(t)&&(this.attributes[t]=this.attributes[t].replace(e,""))}get(t){return this.attributes.hasOwnProperty(t)?this.attributes[t]:null}is(t,e){return!!this.attributes.hasOwnProperty(t)&&this.attributes[t].includes(e)}findKeysForCharacter(t){const e=[];for(const o in this.attributes)this.attributes.hasOwnProperty(o)&&this.attributes[o].includes(t)&&e.push(o);return e.length>0?e:null}},centerPlayer:t=>{let[e,o]=t;return e+=positionX,o+=positionY,platformer.scrollWorld(help.lerp([0,0],help.subtract([e,o],[owotWidth/2,owotHeight/2]),.01))},scrollWorld:(t=[0,0])=>{const[e,o]=t,n=e,i=o;return positionY-=i,positionX-=n,w.emit("scroll",{deltaX:-n,deltaY:-i}),[i,n]},ReadFrequently(){const t=owot.cloneNode();owot.replaceWith(t),owot=t,elm.owot=t,owotCtx=owot.getContext("2d",{willReadFrequently:!0}),w.redraw()},getCanvasArea:(t,e,o,n,i)=>({data:t.getImageData(e,o,n,i).data,x:e,y:o,width:n,height:i}),getCanvasAreaData(t,e,o,n){const i={empty:null,info:null,type:null};let[r,l]=t.location;"top"==o&&(l-=cellH/2),"left"==o&&(r-=cellW/2),"right"==o&&(r+=cellW/4);let{u:a,x:s,y:c}=e;s+=r+positionX,c+=l+positionY;const{data:h,width:u,height:p}=e.data;let[d,f]=[s,c];for(let e=0;e<h.length;e+=4){h[e],h[e+1],h[e+2];if(d>u+s&&(f++,d=s-1),d++,0!==h[e+3]){const e=help.pixelToCell([d,f]);(platformer.settings.debug||n)&&highlight([e],!0,int_to_rgb(8127634*Math.random()));const o=help.getCharInfo(e),r=t.charAttributes.findKeysForCharacter(o.char);return i.empty=o.empty,i.info=o,i.type=r,i}}return i.empty=!0,i},getSectionData(t,e,o,n,i){const r=new ImageData(n,i);for(let l=0;l<i;l++)for(let i=0;i<n;i++){const a=4*((o+l)*t.width+(e+i)),s=4*(l*n+i);r.data[s]=t.data[a],r.data[s+1]=t.data[a+1],r.data[s+2]=t.data[a+2],r.data[s+3]=t.data[a+3]}return{data:r,x:e,y:o}},Player:class{constructor(t=[-1*positionX+owotWidth/2,-1*positionY+owotHeight/2]){this.location=t,this.destination=this.location,this.snapLocation=this.location,this.velocity={x:0,y:0,max:1},this.charAttributes=new platformer.CharAttributes,this.playerAttributes={},this.jumpFrames=0,this.maxJumpFrames=10,this.actions={},this.onCreate()}test(t){console.log("test",t)}onCreate(){platformer.scrollWorld(help.lerp([0,0],help.subtract(this.location,[owotWidth/2,owotHeight/2]),1)),platformer.data.players.push(this),platformer.controls.addKeybinding("moveUp","w",(t=>{this.actions.moveUp="keydown"==t.type})),platformer.controls.addKeybinding("moveLeft","a",(t=>{this.actions.moveLeft="keydown"==t.type})),platformer.controls.addKeybinding("moveDown","s",(t=>{this.actions.moveDown="keydown"==t.type})),platformer.controls.addKeybinding("moveRight","d",(t=>{this.actions.moveRight="keydown"==t.type})),platformer.controls.addKeybinding("attack","space",(t=>{this.actions.attack="keydown"==t.type}))}update(){const[t,e]=platformer.settings.gravity;this.playerAttributes.canMoveUp&&this.actions.moveUp&&(e>=0&&this.jumpFrames<this.maxJumpFrames||e<=0)&&(this.setDestination("up"),this.jumpFrames++),this.playerAttributes.canMoveLeft&&this.actions.moveLeft&&(t>0&&this.jumpFrames<this.maxJumpFrames||t<=0)&&(this.setDestination("left"),this.jumpFrames++),this.playerAttributes.canMoveDown&&this.actions.moveDown&&(e<0&&this.jumpFrames<this.maxJumpFrames||e>=0)&&(this.setDestination("down"),this.jumpFrames++),this.playerAttributes.canMoveRight&&this.actions.moveRight&&(t<0&&this.jumpFrames<this.maxJumpFrames||t>=0)&&this.setDestination("right"),this.playerAttributes.canMoveUp&&this.actions.autoUp&&this.setDestination("auto-up"),this.playerAttributes.canMoveLeft&&this.actions.autoLeft&&this.setDestination("auto-left"),this.playerAttributes.canMoveDown&&this.actions.autoDown&&this.setDestination("auto-down"),this.playerAttributes.canMoveRight&&this.actions.autoRight&&this.setDestination("auto-right"),(this.playerAttributes.canMoveRight||this.playerAttributes.canMoveLeft)&&this.setDestination("float-x"),(this.playerAttributes.canMoveDown||this.playerAttributes.canMoveUp)&&this.setDestination("float-y"),this.climbing?(this.velocity.x=help.lerp(this.velocity.x,0,1),this.velocity.y=help.lerp(this.velocity.y,0,1),this.jumpFrames=0):(this.velocity.x=help.lerp(this.velocity.x,t,platformer.settings.slowdown),this.velocity.y=help.lerp(this.velocity.y,e,platformer.settings.slowdown)),0==this.playerAttributes.canMoveUp&&(this.velocity.y<0&&(this.velocity.y=0),e<0&&(this.jumpFrames=0)),0==this.playerAttributes.canMoveDown&&(this.velocity.y>0&&(this.velocity.y=0),e>0&&(this.jumpFrames=0)),0==this.playerAttributes.canMoveLeft&&(this.velocity.x<0&&(this.velocity.x=0),t<0&&(this.jumpFrames=0)),0==this.playerAttributes.canMoveRight&&(this.velocity.x>0&&(this.velocity.x=0),t>0&&(this.jumpFrames=0));const o=this;!function(){const[t,e]=help.getDistance(o.location,o.destination,!0,!0),[n,i]=o.location,[r,l]=o.destination,a=Math.abs(r-n)>=cellW,s=Math.abs(l-i)>=cellH;o.location=[a?r>n?n+cellW:n-cellW:r,s?l>i?i+cellH:i-cellH:l]}(),o.snapLocation=help.cellToPixel(help.pixelToCell(o.location))}setDestination(t){let[e,o]=this.destination;const[n,i]=platformer.settings.gravity;"up"==t&&(this.velocity.y-=cellW/3),"down"==t&&(this.velocity.y+=cellW/3),"left"==t&&(this.velocity.x-=cellW/3),"right"==t&&(this.velocity.x+=cellW/3),"auto-up"==t&&(this.velocity.y-=.01*cellW+i/10),"auto-down"==t&&(this.velocity.y+=.01*cellW),"auto-left"==t&&(this.velocity.x-=.01*cellW),"auto-right"==t&&(this.velocity.x+=.01*cellW),"float-x"==t&&(e+=this.velocity.x),"float-y"==t&&(o+=this.velocity.y),this.velocity.x>cellW/2&&(this.velocity.x=cellW/2),this.velocity.x<-cellW/2&&(this.velocity.x=-cellW/2),this.velocity.y>cellH/2&&(this.velocity.y=cellH/2),this.velocity.y<-cellW/2&&(this.velocity.y=-cellW/2),this.destination=[e,o]}render(){const t=this;platformer.settings.autoCenterPlayer&&platformer.centerPlayer(this.location),w.redraw(),function(){const[e,o]=t.location;t.layer.drawRectangle(e+positionX,o+positionY,"red")}()}collisionDetection(){const t=this,[e,o]=t.location;this.playerAttributes.isHarmed=!1,this.playerAttributes.canMoveUp=!1,this.playerAttributes.canMoveDown=!1,this.playerAttributes.canMoveLeft=!1,this.playerAttributes.canMoveRight=!1,this.actions.autoRight=!1,this.actions.autoLeft=!1,this.actions.autoUp=!1,this.actions.autoDown=!1,this.climbing=!1;let n=!1;if(platformer.settings.collideWithCanvas){const e=function(t,e){return!!t.type&&(Array.isArray(e)?e.some((e=>t.type.includes(e))):t.type.includes(e))};let o=!1;const i=[t.location[0]+positionX,t.location[1]+positionY];help.getSquarePositions(i,0,1,platformer.settings.debug,(function(t,e){!0!==help.getCharInfo(e).empty&&(o=!0)}));if(o){let o=t.location[0]+positionX,i=t.location[1]+positionY;[o,i]=help.cellToPixel(help.pixelToCell([o,i])),o+=cellW/2,i+=cellH/2;const r=platformer.getCanvasArea(owotCtx,o-cellW,i-cellH,2*cellW,2*cellH),l=platformer.getSectionData(r,0,0,1,1),a=platformer.getSectionData(r,0,cellH,cellW,cellH),s=platformer.getSectionData(r,0,1,2,cellH),c=platformer.getSectionData(r,cellW+1,1,2,cellH),h=platformer.getSectionData(r,0,0,cellW+2,cellH+2),u={top:platformer.getCanvasAreaData(t,l,"top"),bottom:platformer.getCanvasAreaData(t,a,"bottom"),left:platformer.getCanvasAreaData(t,s,"left"),right:platformer.getCanvasAreaData(t,c,"right"),center:platformer.getCanvasAreaData(t,h,"center")};n=u.right.info.json||u.left.info.json||u.top.info.json||u.bottom.info.json||u.center.info.json,(u.top.empty||e(u.top,["ignore","jumpthrough","though_updown"]))&&(t.playerAttributes.canMoveUp=!0),(u.bottom.empty||e(u.bottom,["ignore","fallthough","though_updown"]))&&(t.playerAttributes.canMoveDown=!0),(u.left.empty||e(u.left,["ignore","leftthough","though_leftright"]))&&(t.playerAttributes.canMoveLeft=!0),(u.right.empty||e(u.right,["ignore","rightthough","though_leftright"]))&&(t.playerAttributes.canMoveRight=!0),u.center.empty||e(u.center,["ignore","jumpthrough","fallthough","though_updown","leftthough","rightthough","though_leftright"])?(t.playerAttributes.goodspot=!0,t.playerAttributes.lastGoodSpot=this.location):this.location=help.lerp(this.location,t.playerAttributes.lastGoodSpot,.1);const p=function(){return 0==u.center.empty||0==u.bottom.empty||0==u.top.empty||0==u.left.empty||0==u.right.empty},d=function(t){return e(u.bottom,[t])||e(u.top,[t])||e(u.left,[t])||e(u.right,[t])||e(u.center,[t])};p()&&d("autoRight")&&(this.actions.autoRight=!0),p()&&d("autoLeft")&&(this.actions.autoLeft=!0),p()&&d("autoUp")&&(this.actions.autoUp=!0),p()&&d("autoDown")&&(this.actions.autoDown=!0),p()&&d("climb")&&(this.climbing=!0)}else this.playerAttributes.canMoveUp=!0,this.playerAttributes.canMoveDown=!0,this.playerAttributes.canMoveLeft=!0,this.playerAttributes.canMoveRight=!0;n&&w.emit("handleJSON",n)}else this.playerAttributes.canMoveUp=!0,this.playerAttributes.canMoveDown=!0,this.playerAttributes.canMoveLeft=!0,this.playerAttributes.canMoveRight=!0}}};function snap(){const[t,e,o,n]=getTileCoordsFromMouseCoords(0,0),[i,r]=tileAndCharsToWindowCoords(t,e,o,n);positionX-=i,positionY-=r,w.redraw()}function collisionDetection(){for(const t of platformer.data.players)t.collisionDetection();gameSequence.stepUp()}function update(){for(const t of platformer.data.players)t.update();gameSequence.stepUp()}function cleanUp(){for(const t of platformer.data.layers)t.clear();gameSequence.stepUp()}function render(){setTimeout((function(){gameSequence.stepUp()}),10)}const gameSequence=new help.automation.Sequencer("gameSequence"),stepCollisionDetection=gameSequence.createStep(collisionDetection),stepUpdate=gameSequence.createStep(update),stepCleanUp=gameSequence.createStep(cleanUp),stepRender=gameSequence.createStep(render);w.on("frame",(function(){player.render()})),w.on("handleJSON",(function(t){if(t.draw)for(const e of t.draw){const[t,o,n,i,r,l,a]=e;console.log(t,o,n,i,r,l,a),help.localwriteCharTo(t,o,n,i,r,l,a)}t.alert&&(win||(win=!0,alert(t.alert),location.reload()))})),w.on("resize",(function(){alert("resize not allowed right now"),location.reload()}));let win=!1;w.setFlushInterval(0),gameSequence.sequenceLoop();class CanvasLayer{constructor(t){this.elm=owot.cloneNode(!0),this.elm.id=t,this.ctx=this.elm.getContext("2d"),elm.main_view.appendChild(this.elm),platformer.data.layers.push(this),this.elm.style.top=0,this.elm.style.position="fixed",this.elm.style.zIndex=1e3+platformer.data.layers.length,this.elm.style.pointerEvents="none"}clear(){this.ctx.clearRect(0,0,this.elm.width,this.elm.height)}drawRectangle(t,e,o){const[n,i]=platformer.settings.gravity;this.ctx.fillStyle=o,Math.abs(n)>Math.abs(i)?this.ctx.fillRect(t,e-cellH/4,cellH,cellW):this.ctx.fillRect(t,e-cellH/4,cellW,cellH)}}platformer.ReadFrequently(),w.disableScrolling(),w.disableDragging(),positionX=0,positionY=0,snap();const playerLayer=new CanvasLayer("playerLayer");player=new platformer.Player(help.cellToPixel([0,0,2,7])),player.layer=playerLayer,w.disableCursor(),fd=document.createElement("div"),menu.addEntry(fd),sd=new Date,af=0,glo=t=>{cd=new Date,++af,cd-sd>1e3&&(sd=cd,rf(af),af=0),requestAnimationFrame(glo)},rf=t=>{fd.innerHTML=`<h1>FPS: ${t}</h1>`},glo();
